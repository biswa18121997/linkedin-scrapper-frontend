<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jobs → Google Sheets (Apify)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-10">
  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <h1 class="text-2xl font-bold text-center">Jobs → Google Sheets (Apify)</h1>
    <p class="text-sm text-gray-600 text-center mb-6">
      Fetch from LinkedIn, Indeed, Glassdoor (Apify actors) → append to Sheet1/Sheet2/Sheet3
    </p>

    <!-- Global config -->
    <form id="fetchForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Google Sheet (URL or ID) *</label>
          <input id="sheetInput" name="sheet_id" type="text" required
                 placeholder="Paste full URL or just the ID"
                 class="w-full border rounded-lg p-2"/>
          <p id="sheetDetected" class="text-xs mt-1 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">userID (will fill last column) *</label>
          <input id="userIdInput" name="userID" type="text" required
                 placeholder="e.g., avni@flashfirejobs.com"
                 class="w-full border rounded-lg p-2"/>
        </div>
<!-- title,location, companyName, companyId, publishedAt, rows, workType, contractType, experienceLevel,  -->
        <div>
          <label class="block text-sm font-medium mb-1">Limit per source</label>
          <input id="rows" name="rows" type="number" min="1" max="200" value="20"
                 class="w-full border rounded-lg p-2"/>
        </div>
      </div>

      <hr class="my-2"/>

      <!-- Shared query (optional) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-3">
          <label class="inline-flex items-center gap-2">
            <input id="useShared" type="checkbox" class="h-4 w-4">
            <span class="text-sm">Use shared query for all sources</span>
          </label>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Shared: Job Title</label>
          <input id="title" type="text" placeholder="e.g., Data Analyst"
                 class="w-full border rounded-lg p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared: Location</label>
          <input id="location" type="text" placeholder="e.g., United States" value="United States" 
                 class="w-full border rounded-lg p-2" />
        </div>
         <div>
          <label class="block text-sm font-medium mb-1">Shared: Published At</label>
          <select id="publishedAt" class="w-full border rounded-lg p-2">
            <option value="r86400">24 hours ago</option>
            <option value="r259200">3 days ago</option>
            <option value="r604800">1 week ago</option>
            <option value="r1209600">2 weeks ago</option>
            <option value="r2592000">1 month ago</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared: On-site/Remote(Work-type)</label>
          <select id="workType" class="w-full border rounded-lg p-2">
            <option value="3">Any</option>
            <option value="1">On-site</option>
            <option value="2">Remote</option>
            <option value="3">Hybrid</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared: Contract Type</label>
          <select id="contractType" class="w-full border rounded-lg p-2">
            <option value="">Any</option>
            <option value="F">Full-time</option>
            <option value="P">Part-time</option>
            <option value="C">Contractual</option>
            <option value="T">Temporary</option>
            <option value="I">Internship</option>
            <option value="V">Volunteer/ Apprenticeship</option>
          </select>
        </div>
        <!-- {
    "contractType": "F",
    "experienceLevel": "3",
    "location": "United States",
    "proxy": {
        "useApifyProxy": true,
        "apifyProxyGroups": [
            "RESIDENTIAL"
        ]
    },
    "publishedAt": "r86400",
    "rows": 10,
    "title": "software engineer",
    "workType": "3"
} -->
        <div>
          <label class="block text-sm font-medium mb-1">Shared: Experience-level</label>
          <select id="experienceLevel" class="w-full border rounded-lg p-2">
            <option value="all">Any</option>
            <option value="1">Intern</option>
            <option value="2">Entry-level</option>
            <option value="3">Associate-level</option>
            <option value="4">Mid-senior-level</option>
            <option value="5">Director/Executive-level</option>
          </select>
        </div>
      </div>

      <!-- Per-source cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- LinkedIn -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">LinkedIn → Sheet1</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="linkedinEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>
         
        </div>

        <!-- Indeed -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Indeed → Sheet2</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="indeedEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>
          
        </div>

        <!-- Glassdoor -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Glassdoor → Sheet3</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="glassdoorEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>       
        </div>
      </div>

     <button id="fetchBtn" type="submit"
        class="bg-blue-600 text-white py-2 px-4 rounded-lg w-full hover:bg-blue-700 disabled:opacity-60">
  Fetch from Apify & Append to Sheets
</button>

<!-- ADDED -->
<div id="loading" class="mt-3 text-sm text-blue-700 hidden">Please wait… fetching and appending to Google Sheets.</div>

    </form>

    <!-- Results -->
    <div id="result" class="mt-6 text-sm text-gray-700"></div>

    <div id="previews" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE ='https://linkedin-scrapper-backend-6xzs.onrender.com';
    //  'https://linkedin-scrapper-backend-6xzs.onrender.com'; // your Express server with /api/fetch

    // ===== Helpers =====
    function extractSpreadsheetId(input) {
      const s = String(input || "").trim();
      if (/^[a-zA-Z0-9-_]{20,}$/.test(s)) return s;
      const patterns = [
        /https?:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
        /https?:\/\/docs\.google\.com\/.*\/d\/([a-zA-Z0-9-_]+)/,
        /[\?&]id=([a-zA-Z0-9-_]+)/,
        /https?:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/,
      ];
      for (const re of patterns) {
        const m = s.match(re);
        if (m && m[1]) return m[1];
      }
      return "";
    }

    function sheetDetectedUI(id) {
      const el = document.getElementById('sheetDetected');
      const sheetInput = document.getElementById('sheetInput');
      if (!id) {
        el.textContent = "Invalid Google Sheets URL or ID.";
        el.className = "text-xs mt-1 text-red-600";
        el.classList.remove('hidden');
        input.classList.add('border-red-500');
      } else {
        el.innerHTML = `Detected Sheet ID: <code>${id}</code>`;
        el.className = "text-xs mt-1 text-green-700";
        el.classList.remove('hidden');
        input.classList.remove('border-red-500');
      }
    }

    function previewTable(title, rows) {
      const safeRows = Array.isArray(rows) ? rows : [];
      const first = safeRows[0] || {};
      const cols = Object.keys(first).slice(0, 5); // show a few columns

      const thead = cols.map(c => `<th class="text-left p-2">${c}</th>`).join('');
      const tbody = safeRows.slice(0, 5).map(r => {
        const tds = cols.map(c => `<td class="p-2">${r[c] ?? ''}</td>`).join('');
        return `<tr class="border-t">${tds}</tr>`;
      }).join('') || `<tr><td class="p-2 text-gray-500" colspan="5">No preview</td></tr>`;

      return `
        <div class="border rounded-xl overflow-hidden">
          <div class="bg-gray-50 px-3 py-2 font-semibold">${title}</div>
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50"><tr>${thead}</tr></thead>
            <tbody>${tbody}</tbody>
          </table>
        </div>`;
    }

       // ===== DOM =====
    const form = document.getElementById('fetchForm' )
    const sheetInput = document.getElementById('sheetInput');
    const userIdInput = document.getElementById('userIdInput' )    
    const limit = document.getElementById('rows' )
    const useShared = document.getElementById('useShared' ); 
    const title = document.getElementById('title' )
    const jobLocation = document.getElementById('location' )
    const publishedAt = document.getElementById('publishedAt' )
    const workType = document.getElementById('workType' )
    const contractType = document.getElementById('contractType' )
    const experienceLevel = document.getElementById('experienceLevel');
    const liEnable = document.getElementById('linkedinEnable' )
    const inEnable = document.getElementById('indeedEnable') 
    const gdEnable = document.getElementById('glassdoorEnable')
    const resultEl = document.getElementById('result') 
    const previews = document.getElementById('previews') 
    sheetInput.addEventListener('blur', () => {
      const id = extractSpreadsheetId(sheetInput.value);
      sheetDetectedUI(id);
      if (id) sheetInput.value = id;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      let submitting = true;
      const liChecked = liEnable.checked;
      const inChecked = inEnable.checked;
      const gdChecked = gdEnable.checked;

      let fetchfrom = [];

      if (liChecked) fetchfrom.push('linkedin');
      if (inChecked) fetchfrom.push('indeed');
      if (gdChecked) fetchfrom.push('glassdoor');

      if (fetchfrom.length === 0) {
        resultEl.textContent = 'Please enable at least one source.';
        return;
      }
      if(useShared.checked || (liChecked && inChecked && gdChecked)){
         fetchfrom = ['linkedin', 'indeed', 'glassdoor'];
      }
      else if(!useShared.checked && ( liChecked && inChecked)){
         fetchfrom = ['linkedin', 'indeed'];
      }
      else if(!useShared.checked && (inChecked && gdChecked)){
         fetchfrom = ['indeed', 'glassdoor'];
      }
      else if(!useShared.checked && (gdChecked && liChecked)){
         fetchfrom = ['glassdoor', 'linkedin'];
      }
      else if(!useShared.checked && liChecked){
         fetchfrom = ['linkedin'];
      }
      else if(!useShared.checked && inChecked){
        const fetchfrom = ['indeed'];
      }
      else if(!useShared.checked && gdChecked){
        const fetchfrom = ['glassdoor'];
      }
      else{
        resultEl.textContent = 'Please enable at least one source.';
        return;
      }
      
      previews.innerHTML = '';
      resultEl.textContent = '';

      const sheetId = extractSpreadsheetId(sheetInput.value);
      if (!sheetId) {
        sheetDetectedUI('');
        sheetInput.focus();
        return;
      }
      const userID = String(userIdInput.value || '').trim();
      if (!userID) {
        resultEl.textContent = 'Please enter userID.';
        return;
      }
  const fetchBtn = document.getElementById('fetchBtn');
  const loadingEl = document.getElementById('loading');
  fetchBtn.disabled = true;
  fetchBtn.dataset.prevText = fetchBtn.textContent;
  fetchBtn.textContent = 'Please wait…';
  loadingEl.classList.remove('hidden');
  resultEl.textContent = '';
      

      // const shared = useShared.checked;
      // const liInput = buildSourceInput(
      //   liEnable.checked,
      //   shared,
      //   shared ? sharedQuery.value : liQuery,
      //   shared ? sharedLocation.value : liLocation,
      //   shared ? sharedRemote.value : liRemote
      // );
      // const inInput = buildSourceInput(
      //   inEnable.checked,
      //   shared,
      //   shared ? sharedQuery.value : inQuery,
      //   shared ? sharedLocation.value : inLocation,
      //   shared ? sharedRemote.value : inRemote
      // );
      // const gdInput = buildSourceInput(
      //   gdEnable.checked,
      //   shared,
      //   shared ? sharedQuery.value : gdQuery,
      //   shared ? sharedLocation.value : gdLocation,
      //   shared ? sharedRemote.value : gdRemote
      // );
    
      // If a source is disabled, send an empty object so backend can skip gracefully
      const body = {
        sheet_id: sheetId,
        userID:userIdInput.value,
        limit: limit.value,
        fetchfrom,
        title: title.value,
        jobLocation: jobLocation.value,
        publishedAt: publishedAt.value,
        workType: workType.value,
        contractType: contractType.value,
        experienceLevel: experienceLevel.value
      };
      console.log('Request body:', body);
      try {
    let reqToServer = await fetch(`${API_BASE}/api/fetch`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    let resFromServer = await reqToServer.json();
    console.log(resFromServer);
    // (optional) resultEl.textContent = 'Done!';
  } catch (err) {
    resultEl.textContent = `Error: ${err?.message || err}`;
  } finally {
    // ADDED: hide loading + re-enable button
    submitting = false;
    fetchBtn.disabled = false;
    fetchBtn.textContent = fetchBtn.dataset.prevText || 'Fetch from Apify & Append to Sheets';
    loadingEl.classList.add('hidden');
  }
      // try {
      //   resultEl.textContent = 'Fetching from Apify actors and appending to Google Sheets…';
      //   const res = await fetch(`${API_BASE}/api/fetch`, {
      //     method: 'POST',
      //     headers: { 'Content-Type': 'application/json' },
      //     body: JSON.stringify(body),
      //   });
      //   const data = await res.json();
      //   if (!res.ok || !data.success) throw new Error(data.message || `HTTP ${res.status}`);

      //   // Show per-source summary + tiny previews
      //   const li = data.per_source?.linkedin || {};
      //   const ind = data.per_source?.indeed || {};
      //   const gd = data.per_source?.glassdoor || {};

      //   resultEl.innerHTML = `
      //     <div class="bg-green-50 border border-green-200 rounded-lg p-3">
      //       <div><strong>LinkedIn:</strong> ${li.appended ?? 0} appended (of ${li.total_found ?? 0})</div>
      //       <div><strong>Indeed:</strong> ${ind.appended ?? 0} appended (of ${ind.total_found ?? 0})</div>
      //       <div><strong>Glassdoor:</strong> ${gd.appended ?? 0} appended (of ${gd.total_found ?? 0})</div>
      //     </div>`;

      //   const cards = [];
      //   cards.push(previewTable('LinkedIn preview', li.preview || []));
      //   cards.push(previewTable('Indeed preview', ind.preview || []));
      //   cards.push(previewTable('Glassdoor preview', gd.preview || []));
      //   previews.innerHTML = cards.join('');

      // } catch (err) {
      //   resultEl.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">❌ ${err.message}</div>`;
      // }
    });
  </script>
</body>
</html>
