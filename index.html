<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jobs → Google Sheets (Apify)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-10">
  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <h1 class="text-2xl font-bold text-center">Jobs → Google Sheets (Apify)</h1>
    <p class="text-sm text-gray-600 text-center mb-6">
      Fetch from LinkedIn, Indeed, Glassdoor (Apify actors) → append to Sheet1/Sheet2/Sheet3
    </p>

    <!-- Global config -->
    <form id="fetchForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Google Sheet (URL or ID) *</label>
          <input id="sheetInput" name="sheet_id" type="text" required
                 placeholder="Paste full URL or just the ID"
                 class="w-full border rounded-lg p-2"/>
          <p id="sheetDetected" class="text-xs mt-1 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">userID (will fill last column) *</label>
          <input id="userIdInput" name="userID" type="text" required
                 placeholder="e.g., avni@flashfirejobs.com"
                 class="w-full border rounded-lg p-2"/>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Limit per source</label>
          <input id="limitInput" name="limit" type="number" min="1" max="500" value="100"
                 class="w-full border rounded-lg p-2"/>
        </div>
      </div>

      <hr class="my-2"/>

      <!-- Shared query (optional) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-3">
          <label class="inline-flex items-center gap-2">
            <input id="useShared" type="checkbox" class="h-4 w-4">
            <span class="text-sm">Use shared query for all sources</span>
          </label>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Shared: Query</label>
          <input id="sharedQuery" type="text" placeholder="e.g., Data Analyst"
                 class="w-full border rounded-lg p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared: Location</label>
          <input id="sharedLocation" type="text" placeholder="e.g., United States"
                 class="w-full border rounded-lg p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shared: Remote</label>
          <select id="sharedRemote" class="w-full border rounded-lg p-2">
            <option value="">Any</option>
            <option value="Remote">Remote</option>
            <option value="On-site">On-site</option>
            <option value="Hybrid">Hybrid</option>
          </select>
        </div>
      </div>

      <!-- Per-source cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- LinkedIn -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">LinkedIn → Sheet1</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="linkedinEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>
          <div class="mt-3 space-y-2">
            <input id="liQuery" class="w-full border rounded-lg p-2" placeholder="Query (e.g., Data Analyst)">
            <input id="liLocation" class="w-full border rounded-lg p-2" placeholder="Location (e.g., United States)">
            <select id="liRemote" class="w-full border rounded-lg p-2">
              <option value="">Any</option>
              <option value="Remote">Remote</option>
              <option value="On-site">On-site</option>
              <option value="Hybrid">Hybrid</option>
            </select>
          </div>
        </div>

        <!-- Indeed -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Indeed → Sheet2</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="indeedEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>
          <div class="mt-3 space-y-2">
            <input id="inQuery" class="w-full border rounded-lg p-2" placeholder="Query (e.g., Software Engineer)">
            <input id="inLocation" class="w-full border rounded-lg p-2" placeholder="Location (e.g., United States)">
            <select id="inRemote" class="w-full border rounded-lg p-2">
              <option value="">Any</option>
              <option value="Remote">Remote</option>
              <option value="On-site">On-site</option>
              <option value="Hybrid">Hybrid</option>
            </select>
          </div>
        </div>

        <!-- Glassdoor -->
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Glassdoor → Sheet3</h2>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="glassdoorEnable" type="checkbox" class="h-4 w-4" checked>
              Enable
            </label>
          </div>
          <div class="mt-3 space-y-2">
            <input id="gdQuery" class="w-full border rounded-lg p-2" placeholder="Query (e.g., Product Manager)">
            <input id="gdLocation" class="w-full border rounded-lg p-2" placeholder="Location (e.g., United States)">
            <select id="gdRemote" class="w-full border rounded-lg p-2">
              <option value="">Any</option>
              <option value="Remote">Remote</option>
              <option value="On-site">On-site</option>
              <option value="Hybrid">Hybrid</option>
            </select>
          </div>
        </div>
      </div>

      <button id="fetchBtn" type="submit"
              class="bg-blue-600 text-white py-2 px-4 rounded-lg w-full hover:bg-blue-700 disabled:opacity-60">
        Fetch from Apify & Append to Sheets
      </button>
    </form>

    <!-- Results -->
    <div id="result" class="mt-6 text-sm text-gray-700"></div>

    <div id="previews" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE = 'http://localhost:8085'; // your Express server with /api/fetch

    // ===== Helpers =====
    function extractSpreadsheetId(input) {
      const s = String(input || "").trim();
      if (/^[a-zA-Z0-9-_]{20,}$/.test(s)) return s;
      const patterns = [
        /https?:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
        /https?:\/\/docs\.google\.com\/.*\/d\/([a-zA-Z0-9-_]+)/,
        /[\?&]id=([a-zA-Z0-9-_]+)/,
        /https?:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/,
      ];
      for (const re of patterns) {
        const m = s.match(re);
        if (m && m[1]) return m[1];
      }
      return "";
    }

    function sheetDetectedUI(id) {
      const el = document.getElementById('sheetDetected');
      const input = document.getElementById('sheetInput');
      if (!id) {
        el.textContent = "Invalid Google Sheets URL or ID.";
        el.className = "text-xs mt-1 text-red-600";
        el.classList.remove('hidden');
        input.classList.add('border-red-500');
      } else {
        el.innerHTML = `Detected Sheet ID: <code>${id}</code>`;
        el.className = "text-xs mt-1 text-green-700";
        el.classList.remove('hidden');
        input.classList.remove('border-red-500');
      }
    }

    function previewTable(title, rows) {
      const safeRows = Array.isArray(rows) ? rows : [];
      const first = safeRows[0] || {};
      const cols = Object.keys(first).slice(0, 5); // show a few columns

      const thead = cols.map(c => `<th class="text-left p-2">${c}</th>`).join('');
      const tbody = safeRows.slice(0, 5).map(r => {
        const tds = cols.map(c => `<td class="p-2">${r[c] ?? ''}</td>`).join('');
        return `<tr class="border-t">${tds}</tr>`;
      }).join('') || `<tr><td class="p-2 text-gray-500" colspan="5">No preview</td></tr>`;

      return `
        <div class="border rounded-xl overflow-hidden">
          <div class="bg-gray-50 px-3 py-2 font-semibold">${title}</div>
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50"><tr>${thead}</tr></thead>
            <tbody>${tbody}</tbody>
          </table>
        </div>`;
    }

    function buildSourceInput(enabled, shared, q, loc, remote) {
    if (!enabled) return null;

    // Extract raw values whether 'shared' or element refs were passed
    const queryVal = shared ? (q || '').trim() : String(q?.value || '').trim();
    const locVal   = shared ? (loc || '').trim() : String(loc?.value || '').trim();
    const remoteVal= shared ? (remote || '').trim() : String(remote?.value || '').trim();

    const obj = {};
    // ensure both query and keyword are sent
    obj.query = queryVal || 'Software Engineer';
    obj.keyword = obj.query;

    // default country/location = United States
    obj.location = locVal || 'United States';
    obj.country  = 'US';

    if (remoteVal) obj.remote = remoteVal;

    return obj;
  }
    // ===== DOM =====
    const form = document.getElementById('fetchForm');
    const sheetInput = document.getElementById('sheetInput');
    const useShared = document.getElementById('useShared');
    const sharedQuery = document.getElementById('sharedQuery');
    const sharedLocation = document.getElementById('sharedLocation');
    const sharedRemote = document.getElementById('sharedRemote');
    const liEnable = document.getElementById('linkedinEnable');
    const inEnable = document.getElementById('indeedEnable');
    const gdEnable = document.getElementById('glassdoorEnable');
    const liQuery = document.getElementById('liQuery');
    const liLocation = document.getElementById('liLocation');
    const liRemote = document.getElementById('liRemote');
    const inQuery = document.getElementById('inQuery');
    const inLocation = document.getElementById('inLocation');
    const inRemote = document.getElementById('inRemote');
    const gdQuery = document.getElementById('gdQuery');
    const gdLocation = document.getElementById('gdLocation');
    const gdRemote = document.getElementById('gdRemote');
    const userIdInput = document.getElementById('userIdInput');
    const limitInput = document.getElementById('limitInput');
    const resultEl = document.getElementById('result');
    const previews = document.getElementById('previews');

    sheetInput.addEventListener('blur', () => {
      const id = extractSpreadsheetId(sheetInput.value);
      sheetDetectedUI(id);
      if (id) sheetInput.value = id;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      previews.innerHTML = '';
      resultEl.textContent = '';

      const sheetId = extractSpreadsheetId(sheetInput.value);
      if (!sheetId) {
        sheetDetectedUI('');
        sheetInput.focus();
        return;
      }
      const userID = String(userIdInput.value || '').trim();
      if (!userID) {
        resultEl.textContent = 'Please enter userID.';
        return;
      }
      const limit = Math.max(1, Math.min(Number(limitInput.value || 100), 500));

      const shared = useShared.checked;
      const liInput = buildSourceInput(
        liEnable.checked,
        shared,
        shared ? sharedQuery.value : liQuery,
        shared ? sharedLocation.value : liLocation,
        shared ? sharedRemote.value : liRemote
      );
      const inInput = buildSourceInput(
        inEnable.checked,
        shared,
        shared ? sharedQuery.value : inQuery,
        shared ? sharedLocation.value : inLocation,
        shared ? sharedRemote.value : inRemote
      );
      const gdInput = buildSourceInput(
        gdEnable.checked,
        shared,
        shared ? sharedQuery.value : gdQuery,
        shared ? sharedLocation.value : gdLocation,
        shared ? sharedRemote.value : gdRemote
      );

      // If a source is disabled, send an empty object so backend can skip gracefully
      const body = {
        sheet_id: sheetId,
        userID,
        limit,
        linkedinInput: liInput || {},
        indeedInput: inInput || {},
        glassdoorInput: gdInput || {},
      };

      try {
        resultEl.textContent = 'Fetching from Apify actors and appending to Google Sheets…';
        const res = await fetch(`${API_BASE}/api/fetch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || `HTTP ${res.status}`);

        // Show per-source summary + tiny previews
        const li = data.per_source?.linkedin || {};
        const ind = data.per_source?.indeed || {};
        const gd = data.per_source?.glassdoor || {};

        resultEl.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div><strong>LinkedIn:</strong> ${li.appended ?? 0} appended (of ${li.total_found ?? 0})</div>
            <div><strong>Indeed:</strong> ${ind.appended ?? 0} appended (of ${ind.total_found ?? 0})</div>
            <div><strong>Glassdoor:</strong> ${gd.appended ?? 0} appended (of ${gd.total_found ?? 0})</div>
          </div>`;

        const cards = [];
        cards.push(previewTable('LinkedIn preview', li.preview || []));
        cards.push(previewTable('Indeed preview', ind.preview || []));
        cards.push(previewTable('Glassdoor preview', gd.preview || []));
        previews.innerHTML = cards.join('');

      } catch (err) {
        resultEl.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">❌ ${err.message}</div>`;
      }
    });
  </script>
</body>
</html>
